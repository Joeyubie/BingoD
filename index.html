<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Game</title>
    <style>
        /* Your existing CSS styles */
    </style>
</head>
<body>
    <button onclick="toggleDarkMode()" aria-label="Toggle Dark Mode">Toggle Dark Mode</button>
    <button onclick="resetGame()">New Game</button>
    <div id="bingo-modal" class="modal" aria-hidden="true" tabindex="-1" aria-live="polite">
        <p id="modal-message">Bingo! You won!</p>
        <button onclick="closeModal()" aria-label="Close Modal">Close</button>
    </div>
    <p>Wins: <span id="win-counter">0</span></p>
    <p>Time: <span id="timer">0:00</span></p>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script>
        let tableCells = [];
        let startTime;
        let timerInterval;

        // Retrieve win count from localStorage or initialize to 0
        let winCount = parseInt(localStorage.getItem("winCount")) || 0;
        document.getElementById("win-counter").innerText = winCount;

        // Shuffle array function
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        // Generate Bingo card
        const generateBingoCard = (phrases) => {
            let shuffledPhrases = shuffleArray(phrases).slice(0, 24);
            let card = [];
            for (let i = 0; i < 5; i++) {
                let row = shuffledPhrases.slice(i * 5, (i + 1) * 5);
                if (i === 2) {
                    row.splice(2, 0, "Free Space");
                }
                card.push(row);
            }
            return card;
        };

        // Check for a win
        const checkWin = () => {
            // Check rows
            for (let row of tableCells) {
                if (row.every(cell => cell.classList.contains("marked"))) {
                    return highlightWin(row);
                }
            }
            // Check columns
            for (let i = 0; i < 5; i++) {
                if (tableCells.every(row => row[i].classList.contains("marked"))) {
                    return highlightWin(tableCells.map(row => row[i]));
                }
            }
            // Check diagonals
            if (tableCells.every((row, idx) => row[idx].classList.contains("marked"))) {
                return highlightWin(tableCells.map((row, idx) => row[idx]));
            }
            if (tableCells.every((row, idx) => row[4 - idx].classList.contains("marked"))) {
                return highlightWin(tableCells.map((row, idx) => row[4 - idx]));
            }
            return false;
        };

        // Highlight winning cells and show modal
        const highlightWin = (winningCells) => {
            winningCells.forEach(cell => cell.classList.add("winning"));
            document.getElementById("bingo-modal").style.display = "block";
            document.getElementById("modal-message").innerText = `Bingo! You won in ${getElapsedTime()}!`;

            // Increment win count and update localStorage
            winCount++;
            localStorage.setItem("winCount", winCount);
            document.getElementById("win-counter").innerText = winCount;

            // Confetti effect
            confetti({
                particleCount: 300,
                spread: 360,
                origin: { y: 0.6 },
            });

            // Automatically reset the game after 3 seconds
            setTimeout(() => {
                resetGame();
            }, 3000);
        };

        // Reset game
        const resetGame = () => {
            clearInterval(timerInterval);
            startTimer();
            document.getElementById("bingo-modal").style.display = "none";
            document.querySelector("table")?.remove();
            let phrases = ["Gang", "Minimize", "look up", "1 minute break", "Just 5 minutes of notes", "*Leaves class for no reason*", "Could you speak up?", "*Glazes Trump", "Absolutely", "Never", "Why not?", "Exactly", "Interesting", "Tell me more", "I see", "Not sure", "Of course", "Let's go", "Cool", "Sounds good", "No way", "Unbelievable", "Fantastic", "Incredible", "Wow"];
            let card = generateBingoCard(phrases);
            renderBingoCard(card);
        };

        // Render Bingo card
        const renderBingoCard = (card) => {
            let table = document.createElement("table");
            let letters = ["B", "I", "N", "G", "O"];
            let headerRow = document.createElement("tr");
            tableCells = [];
            letters.forEach(letter => {
                let th = document.createElement("th");
                th.innerText = letter;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            for (let i = 0; i < 5; i++) {
                let row = document.createElement("tr");
                tableCells[i] = [];
                for (let j = 0; j < 5; j++) {
                    let cell = document.createElement("td");
                    cell.innerText = card[i][j];
                    if (i === 2 && j === 2) {
                        cell.classList.add("marked"); // Mark "Free Space"
                    }
                    cell.addEventListener("click", () => {
                        if (!cell.classList.contains("marked")) {
                            cell.classList.add("marked");
                            checkWin();
                        }
                    });
                    tableCells[i].push(cell);
                    row.appendChild(cell);
                }
                table.appendChild(row);
            }
            document.body.appendChild(table);
        };

        // Toggle dark mode
        const toggleDarkMode = () => {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
        };

        // Close modal
        const closeModal = () => {
            document.getElementById("bingo-modal").style.display = "none";
        };

        // Start timer
        const startTimer = () => {
            startTime = new Date();
            timerInterval = setInterval(() => {
                document.getElementById("timer").innerText = getElapsedTime();
            }, 1000);
        };

        // Get elapsed time
        const getElapsedTime = () => {
            if (!startTime) return "0:00";
            const elapsed = new Date() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, "0")}`;
        };

        // Initialize game
        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("darkMode") === "true") {
                document.body.classList.add("dark-mode");
            }
            resetGame();
        });
    </script>
</body>
</html>
